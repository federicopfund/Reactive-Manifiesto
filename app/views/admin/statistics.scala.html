@(username: String)(implicit request: RequestHeader, flash: Flash)

@admin.adminLayout("Estad√≠sticas Avanzadas") {
    <div class="stats-header" style="margin-bottom: 2rem;">
        <h2 style="font-size: 2rem; color: #333; margin-bottom: 0.5rem;">üìä Estad√≠sticas y An√°lisis</h2>
        <p style="color: #666;">Panel de control profesional de m√©tricas y KPIs</p>
    </div>

    <!-- Loading State -->
    <div id="loading" style="text-align: center; padding: 3rem;">
        <div style="display: inline-block; width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 1rem; color: #666;">Cargando estad√≠sticas...</p>
    </div>

    <style>
        @@keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-change {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .positive { background: #d4edda; color: #155724; }
        .negative { background: #f8d7da; color: #721c24; }
        .neutral { background: #d1ecf1; color: #0c5460; }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }
    </style>

    <!-- Main Stats Container (Hidden until loaded) -->
    <div id="statsContainer" style="display: none;">
        
        <!-- KPIs Principales -->
        <div class="section-title">üéØ KPIs Principales</div>
        <div class="kpi-grid" id="mainKpis"></div>

        <!-- M√©tricas de Usuarios -->
        <div class="section-title">üë• M√©tricas de Usuarios</div>
        <div class="kpi-grid" id="userMetrics"></div>

        <!-- Gr√°ficos de Usuarios -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: #333;">üìà Crecimiento de Usuarios</h3>
                <canvas id="userGrowthChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: #333;">üë§ Usuarios por Rol</h3>
                <canvas id="userRoleChart"></canvas>
            </div>
        </div>

        <!-- M√©tricas de Contactos -->
        <div class="section-title">üì® M√©tricas de Contactos</div>
        <div class="kpi-grid" id="contactMetrics"></div>

        <!-- Gr√°ficos de Contactos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: #333;">üìä Distribuci√≥n por Estado</h3>
                <canvas id="contactStatusChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: #333;">üìÖ Actividad Mensual</h3>
                <canvas id="activityChart"></canvas>
            </div>
        </div>

        <!-- M√©tricas de Rendimiento -->
        <div class="section-title">‚ö° Rendimiento del Sistema</div>
        <div class="kpi-grid" id="performanceMetrics"></div>

        <!-- Resumen de Administradores -->
        <div class="section-title">üîß Equipo de Administraci√≥n</div>
        <div class="kpi-grid" id="adminMetrics"></div>

    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@@4.4.1/dist/chart.umd.js"></script>
    
    <script>
        // Configuraci√≥n de colores
        const colors = {
            primary: '#667eea',
            secondary: '#764ba2',
            success: '#43e97b',
            danger: '#f5576c',
            warning: '#feca57',
            info: '#48dbfb',
            purple: '#a29bfe',
            pink: '#fd79a8',
            orange: '#ff7675',
            teal: '#00cec9'
        };

        // Cargar estad√≠sticas
        fetch('/admin/stats/advanced')
            .then(response => response.json())
            .then(data => {
                console.log('üìä Estad√≠sticas cargadas:', data);
                renderStats(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'block';
            })
            .catch(error => {
                console.error('Error cargando estad√≠sticas:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #f5576c;">‚ùå Error al cargar estad√≠sticas</p>';
            });

        function renderStats(data) {
            // KPIs Principales
            renderKPIs('mainKpis', [
                {
                    icon: 'üë•',
                    value: data.users.total,
                    label: 'Usuarios Totales',
                    change: `+${data.users.newLast7Days} esta semana`,
                    changeType: 'positive'
                },
                {
                    icon: 'üì®',
                    value: data.contacts.total,
                    label: 'Contactos Totales',
                    change: `+${data.contacts.newLast7Days} esta semana`,
                    changeType: 'positive'
                },
                {
                    icon: 'üî•',
                    value: data.users.activeLast7Days,
                    label: 'Usuarios Activos (7d)',
                    change: `${data.users.activationRate}% de activaci√≥n`,
                    changeType: 'neutral'
                },
                {
                    icon: '‚ö°',
                    value: `${data.performance.efficiency}%`,
                    label: 'Eficiencia de Procesamiento',
                    change: `${data.contacts.processed} procesados`,
                    changeType: data.performance.efficiency > 70 ? 'positive' : 'warning'
                }
            ]);

            // M√©tricas de Usuarios
            renderKPIs('userMetrics', [
                {
                    icon: 'üÜï',
                    value: data.users.newLast30Days,
                    label: 'Nuevos (30 d√≠as)',
                    change: `${data.users.newLast7Days} √∫ltima semana`,
                    changeType: 'neutral'
                },
                {
                    icon: 'üí§',
                    value: data.users.neverLoggedIn,
                    label: 'Sin Login',
                    change: `${((data.users.neverLoggedIn / data.users.total) * 100).toFixed(1)}% del total`,
                    changeType: 'warning'
                },
                {
                    icon: 'üìä',
                    value: `${data.users.avgAccountAgeDays}d`,
                    label: 'Edad Promedio Cuenta',
                    change: 'd√≠as desde creaci√≥n',
                    changeType: 'neutral'
                },
                {
                    icon: 'üîÑ',
                    value: `${data.users.weeklyGrowthPercent}%`,
                    label: 'Crecimiento Semanal',
                    change: 'vs promedio mensual',
                    changeType: data.users.weeklyGrowthPercent > 0 ? 'positive' : 'negative'
                }
            ]);

            // M√©tricas de Contactos
            renderKPIs('contactMetrics', [
                {
                    icon: 'üïê',
                    value: data.contacts.pending,
                    label: 'Pendientes',
                    change: 'requieren atenci√≥n',
                    changeType: data.contacts.pending > 10 ? 'warning' : 'neutral'
                },
                {
                    icon: '‚úÖ',
                    value: data.contacts.processed,
                    label: 'Procesados',
                    change: `${data.contacts.processingRate}% del total`,
                    changeType: 'positive'
                },
                {
                    icon: 'üìÅ',
                    value: data.contacts.archived,
                    label: 'Archivados',
                    change: 'hist√≥rico',
                    changeType: 'neutral'
                },
                {
                    icon: 'üìà',
                    value: data.contacts.contactsPerActiveUser,
                    label: 'Contactos/Usuario Activo',
                    change: 'promedio',
                    changeType: 'neutral'
                }
            ]);

            // M√©tricas de Rendimiento
            renderKPIs('performanceMetrics', [
                {
                    icon: '‚è±Ô∏è',
                    value: `${data.performance.avgResponseTimeDays}d`,
                    label: 'Tiempo Respuesta Promedio',
                    change: 'd√≠as',
                    changeType: data.performance.avgResponseTimeDays < 3 ? 'positive' : 'warning'
                },
                {
                    icon: 'üìã',
                    value: data.performance.pendingBacklog,
                    label: 'Backlog Pendiente',
                    change: 'items en cola',
                    changeType: data.performance.pendingBacklog > 20 ? 'warning' : 'positive'
                },
                {
                    icon: 'üéØ',
                    value: `${data.performance.efficiency}%`,
                    label: 'Eficiencia',
                    change: 'tasa de completaci√≥n',
                    changeType: data.performance.efficiency > 70 ? 'positive' : 'warning'
                }
            ]);

            // M√©tricas de Administradores
            renderKPIs('adminMetrics', [
                {
                    icon: 'üë®‚Äçüíº',
                    value: data.admins.total,
                    label: 'Total Administradores',
                    change: 'en el sistema',
                    changeType: 'neutral'
                },
                {
                    icon: 'üü¢',
                    value: data.admins.recentActivity,
                    label: 'Activos (7 d√≠as)',
                    change: 'con actividad reciente',
                    changeType: 'positive'
                }
            ]);

            // Renderizar gr√°ficos
            renderCharts(data);
        }

        function renderKPIs(containerId, kpis) {
            const container = document.getElementById(containerId);
            container.innerHTML = kpis.map(kpi => `
                <div class="stat-card">
                    <div style="font-size: 2.5rem;">${kpi.icon}</div>
                    <div class="stat-value" style="color: ${colors.primary};">${kpi.value}</div>
                    <div class="stat-label">${kpi.label}</div>
                    <div class="stat-change ${kpi.changeType}">${kpi.change}</div>
                </div>
            `).join('');
        }

        function renderCharts(data) {
            // Gr√°fico de Crecimiento de Usuarios
            new Chart(document.getElementById('userGrowthChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Hace 30d', 'Hace 21d', 'Hace 14d', 'Hace 7d', 'Hoy'],
                    datasets: [{
                        label: 'Usuarios Registrados',
                        data: [
                            Math.max(0, data.users.total - data.users.newLast30Days),
                            Math.max(0, data.users.total - data.users.newLast30Days + Math.floor(data.users.newLast30Days * 0.3)),
                            Math.max(0, data.users.total - data.users.newLast7Days),
                            Math.max(0, data.users.total - Math.floor(data.users.newLast7Days * 0.5)),
                            data.users.total
                        ],
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gr√°fico de Usuarios por Rol
            const roleLabels = Object.keys(data.users.byRole);
            const roleValues = Object.values(data.users.byRole);
            new Chart(document.getElementById('userRoleChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: roleLabels.map(r => r.toUpperCase()),
                    datasets: [{
                        data: roleValues,
                        backgroundColor: [colors.primary, colors.success, colors.warning, colors.info],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Gr√°fico de Estado de Contactos
            new Chart(document.getElementById('contactStatusChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Pendientes', 'Procesados', 'Archivados'],
                    datasets: [{
                        label: 'Cantidad',
                        data: [data.contacts.pending, data.contacts.processed, data.contacts.archived],
                        backgroundColor: [colors.warning, colors.success, colors.info],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gr√°fico de Actividad Mensual
            new Chart(document.getElementById('activityChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                    datasets: [{
                        label: 'Nuevos Contactos',
                        data: [
                            Math.floor(data.contacts.newLast30Days * 0.2),
                            Math.floor(data.contacts.newLast30Days * 0.25),
                            Math.floor(data.contacts.newLast30Days * 0.25),
                            data.contacts.newLast7Days
                        ],
                        borderColor: colors.danger,
                        backgroundColor: colors.danger + '20',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Nuevos Usuarios',
                        data: [
                            Math.floor(data.users.newLast30Days * 0.2),
                            Math.floor(data.users.newLast30Days * 0.25),
                            Math.floor(data.users.newLast30Days * 0.25),
                            data.users.newLast7Days
                        ],
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        console.log('üìä Sistema de estad√≠sticas avanzadas inicializado');
    </script>
}
